name: Daily Usage Check
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“9æ™‚ï¼‰ã«å®Ÿè¡Œ
  workflow_dispatch:     # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  usage-check:
    runs-on: ubuntu-latest
    steps:
      - name: Daily Usage Monitoring
        run: |
          echo "ğŸš€ Starting daily usage check for Nekosama Gallery..."
          
          # APIå‘¼ã³å‡ºã—
          response=$(curl -s -w "%{http_code}" -X POST \
            "https://nekosama-gallery.pages.dev/api/daily-usage-check" \
            -H "Content-Type: application/json" \
            -H "User-Agent: github-actions" \
            -d "{\"secret\": \"${{ secrets.DAILY_CHECK_SECRET }}\"}")
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
          http_code="${response: -3}"
          response_body="${response%???}"
          
          echo "ğŸ“Š HTTP Status: $http_code"
          echo "ğŸ“ Response: $response_body"
          
          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          if [ "$http_code" != "200" ]; then
            echo "âŒ Daily usage check failed with status $http_code"
            echo "$response_body"
            exit 1
          else
            echo "âœ… Daily usage check completed successfully"
          fi
          
      - name: Weekly Summary (Sundays)
        if: github.event.schedule == '0 0 * * *' && format('{0}', github.event.schedule) == '0 0 * * *'
        run: |
          day_of_week=$(date +%u)  # 1=Monday, 7=Sunday
          if [ "$day_of_week" = "7" ]; then
            echo "ğŸ“… Today is Sunday - triggering weekly summary"
            curl -X POST \
              "https://nekosama-gallery.pages.dev/api/daily-usage-check" \
              -H "Content-Type: application/json" \
              -H "User-Agent: github-actions" \
              -d "{\"secret\": \"${{ secrets.DAILY_CHECK_SECRET }}\", \"summaryOnly\": true}"
          fi